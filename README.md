# Terraform AWS Platform Template

A production-ready Terraform template that bootstraps an AWS S3 remote backend with strong environment separation, guardrails, and a single setup wizard experience.

## Features

- **One-command setup** - Interactive wizard generates all configs and provisions IAM
- **Self-bootstrapping** - Bootstrap state persists to the S3 bucket it creates
- **Environment isolation** - Separate AWS accounts/state per environment (dev/stage/prod)
- **Native lockfiles** - Uses Terraform 1.14+ S3 backend with `use_lockfile = true`
- **GitHub Actions CI/CD** - Single unified workflow for all operations
- **Guardrails** - Account/region checks prevent cross-environment mistakes

## Quick Start

```bash
# 1. Clone this template
git clone <this-repo> my-infra
cd my-infra/infra

# 2. Run the setup wizard
./scripts/setup.sh      # Linux/macOS
./scripts/setup.ps1     # Windows PowerShell

# 3. The wizard will:
#    - Prompt for org prefix, region, account IDs
#    - Optionally provision OIDC provider and IAM roles
#    - Generate all configuration files
#    - Output GitHub secrets to configure

# 4. Commit and push
git add -A && git commit -m "Configure Terraform"
git push origin main

# 5. Run bootstrap via GitHub Actions
#    Actions → Terraform → Run workflow
#    - target: bootstrap
#    - env: dev
#    - action: apply
#    - bootstrap-phase: initial
#
#    After success, run again with bootstrap-phase: migrate
```

## Repository Structure

```
infra/
├── bootstrap/           # Backend provisioning (S3 bucket, KMS)
│   ├── main.tf
│   ├── backend.tf       # S3 backend for bootstrap state
│   ├── dev.tfvars       # Generated by setup wizard
│   └── dev.backend.hcl  # Generated by setup wizard
├── live/                # Deployable stacks by environment
│   ├── dev/
│   │   └── storage/
│   │       ├── main.tf
│   │       ├── backend.hcl      # Generated by setup wizard
│   │       └── terraform.tfvars # Generated by setup wizard
│   ├── stage/
│   └── prod/
├── modules/             # Reusable modules
└── scripts/
    ├── setup.sh         # Setup wizard (bash)
    ├── setup.ps1        # Setup wizard (PowerShell)
    ├── tf               # CLI wrapper (bash)
    └── tf.ps1           # CLI wrapper (PowerShell)
```

## Setup Wizard

The setup wizard (`setup.sh` / `setup.ps1`) handles everything:

1. **Configuration prompts**
   - Organization prefix (e.g., `acme`)
   - Primary AWS region
   - GitHub org/repo for OIDC
   - Per-environment AWS account IDs and role names

2. **IAM provisioning** (optional, requires AWS admin access)
   - Creates GitHub OIDC identity provider
   - Creates `TerraformBootstrapRole` and `TerraformExecutionRole`
   - Attaches least-privilege policies

3. **Config file generation**
   - `bootstrap/<env>.tfvars` and `bootstrap/<env>.backend.hcl`
   - `live/<env>/<stack>/backend.hcl` and `terraform.tfvars`

4. **Outputs GitHub secrets** needed for CI/CD

## Bootstrap Process

The bootstrap creates the S3 state bucket and persists its own state using a two-phase approach:

| Phase | Command | Description |
|-------|---------|-------------|
| `initial` | Creates bucket | Runs with local state |
| `migrate` | Migrates state | Moves local state to S3 |
| `normal` | Standard ops | All subsequent operations |

## GitHub Actions Workflow

Single workflow (`.github/workflows/terraform.yml`) handles all operations:

| Trigger | Behavior |
|---------|----------|
| Pull Request | `terraform plan` on live stacks |
| Push to main | `terraform apply` on live stacks |
| workflow_dispatch | Manual operations for bootstrap or live |

### Required GitHub Environment Secrets

Configure these in each GitHub Environment (dev, stage, prod):

| Secret | Description |
|--------|-------------|
| `AWS_REGION` | Primary AWS region |
| `AWS_BOOTSTRAP_ROLE_ARN` | IAM role for bootstrap operations |
| `AWS_ROLE_ARN` | IAM role for stack operations |

## Local Development

Local execution is disabled by default. For break-glass scenarios:

```bash
export ALLOW_LOCAL_TF=1
cd infra
./scripts/tf env=dev stack=storage plan
```

## Adding a New Stack

1. Copy an existing stack:
   ```bash
   cp -r infra/live/dev/storage infra/live/dev/newstack
   ```

2. Update `backend.hcl` with new state key

3. Update `main.tf` for your resources

4. Add to workflow matrix in `.github/workflows/terraform.yml`

## Prerequisites

- Terraform CLI 1.14.x
- AWS CLI (for setup wizard IAM provisioning)
- Git

## Notes

- State bucket naming: `<org>-tfstate-<env>-<account>-<region>[-<suffix>]`
- DynamoDB locking is not used; native lockfiles are enabled
- Bootstrap state lives in the same bucket it creates
