name: Terraform Bootstrap

on:
  workflow_dispatch:
    inputs:
      env:
        type: choice
        options: [dev, stage, prod]
        default: dev
        description: "Target environment"
      action:
        type: choice
        options: [plan, apply]
        default: plan
        description: "Terraform action"

permissions:
  id-token: write
  contents: read

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    environment: ${{ inputs.env }}
    concurrency: terraform-bootstrap-${{ inputs.env }}
    env:
      TF_WORKDIR: ${{ vars.TF_WORKDIR || 'infra' }}
      TF_ORG_PREFIX: ${{ secrets.TF_ORG_PREFIX || vars.TF_ORG_PREFIX }}
      TF_STATE_BUCKET_SUFFIX: ${{ secrets.TF_STATE_BUCKET_SUFFIX || vars.TF_STATE_BUCKET_SUFFIX }}
      TF_ENABLE_ACCESS_LOGS: ${{ secrets.TF_ENABLE_ACCESS_LOGS || vars.TF_ENABLE_ACCESS_LOGS || 'false' }}
      TF_LOG_BUCKET_NAME: ${{ secrets.TF_LOG_BUCKET_NAME || vars.TF_LOG_BUCKET_NAME }}
      TF_LOG_BUCKET_PREFIX: ${{ secrets.TF_LOG_BUCKET_PREFIX || vars.TF_LOG_BUCKET_PREFIX || 'tfstate/' }}
      TF_USE_KMS: ${{ secrets.TF_USE_KMS || vars.TF_USE_KMS || 'true' }}
      TF_EXTRA_TAGS_HCL: ${{ secrets.TF_EXTRA_TAGS_HCL || vars.TF_EXTRA_TAGS_HCL }}
      AWS_ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID || vars.AWS_ACCOUNT_ID }}
      AWS_REGION: ${{ secrets.AWS_REGION || vars.AWS_REGION }}
      AWS_BOOTSTRAP_ROLE_ARN: ${{ secrets.AWS_BOOTSTRAP_ROLE_ARN || vars.AWS_BOOTSTRAP_ROLE_ARN }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN || vars.AWS_ROLE_ARN }}
    defaults:
      run:
        working-directory: ${{ env.TF_WORKDIR }}
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.14.x
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_BOOTSTRAP_ROLE_ARN || vars.AWS_BOOTSTRAP_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION || vars.AWS_REGION }}
      - name: Render bootstrap tfvars
        run: |
          set -euo pipefail
          : "${TF_ORG_PREFIX?Missing TF_ORG_PREFIX}"
          : "${AWS_ACCOUNT_ID?Missing AWS_ACCOUNT_ID}"
          : "${AWS_REGION?Missing AWS_REGION}"
          : "${AWS_BOOTSTRAP_ROLE_ARN?Missing AWS_BOOTSTRAP_ROLE_ARN}"
          : "${AWS_ROLE_ARN?Missing AWS_ROLE_ARN}"

          suffix="${TF_STATE_BUCKET_SUFFIX:-}"
          log_bucket_name="${TF_LOG_BUCKET_NAME:-}"
          log_bucket_prefix="${TF_LOG_BUCKET_PREFIX:-tfstate/}"
          enable_access_logs="${TF_ENABLE_ACCESS_LOGS:-false}"
          use_kms="${TF_USE_KMS:-true}"
          extra_tags="${TF_EXTRA_TAGS_HCL:-{}}"

          if [ -z "$log_bucket_name" ]; then
            log_bucket_hcl="null"
          else
            log_bucket_hcl="\"$log_bucket_name\""
          fi

          cat > "bootstrap/${{ inputs.env }}.tfvars" <<EOF
          org_prefix = "$TF_ORG_PREFIX"
          env        = "${{ inputs.env }}"
          account_id = "$AWS_ACCOUNT_ID"

          primary_region     = "$AWS_REGION"
          state_bucket_suffix = "$suffix"

          use_kms            = ${use_kms}
          enable_access_logs = ${enable_access_logs}
          log_bucket_name    = ${log_bucket_hcl}
          log_bucket_prefix  = "$log_bucket_prefix"

          aws_profile     = null
          assume_role_arn = null

          state_bucket_admin_principals = ["$AWS_BOOTSTRAP_ROLE_ARN"]
          state_bucket_rw_principals = ["$AWS_ROLE_ARN"]
          kms_admin_principals = ["$AWS_BOOTSTRAP_ROLE_ARN"]

          extra_tags = ${extra_tags}
          EOF
      - run: terraform -chdir=bootstrap init
      - name: Terraform plan/apply
        run: |
          if [ "${{ inputs.action }}" = "apply" ]; then
            terraform -chdir=bootstrap apply -var-file=${{ inputs.env }}.tfvars -auto-approve -input=false
          else
            terraform -chdir=bootstrap plan -var-file=${{ inputs.env }}.tfvars -input=false
          fi
